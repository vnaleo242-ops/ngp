<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô Phỏng Đo Sóng Âm</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Đảm bảo Canvas chiếm toàn bộ không gian container */
        #oscilloscope {
            background-color: #0d1117; /* Màu nền tối cho cảm giác máy hiện sóng */
            border-radius: 0.5rem;
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        .text-red-experiment {
            color: #ef4444; /* Màu đỏ cho sai số tỷ đối */
            font-weight: 600;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }
        /* Media query cho mobile */
        @media (max-width: 1024px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-100 p-4 lg:p-8 font-sans">
            <a href="index.html" class="fixed top-4 left-4 z-50 p-3 bg-blue-600 text-white rounded-lg shadow-xl hover:bg-blue-700 transition duration-300 flex items-center space-x-2">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
    </svg>
    <span class="font-semibold hidden sm:inline">Quay về Trang Chủ</span>
        </a>

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-center text-teal-300">
            Mô Phỏng Thực Hành Đo Sóng Âm
        </h1>

        <div class="grid-container">
            <!-- Cột 1: Điều khiển và Đồ thị Sóng Âm -->
            <div class="space-y-6">
                
                <!-- Bảng Điều khiển Nguồn Âm -->
                <div class="bg-gray-700 p-4 rounded-xl shadow-lg border border-gray-600">
                    <h2 class="text-xl font-semibold mb-3 text-teal-400">1. Điều Khiển Nguồn Âm</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        
                        <!-- Tần Số Có Sẵn -->
                        <div class="p-3 bg-gray-600 rounded-lg space-y-2">
                            <h3 class="font-medium text-lg text-yellow-300">Tạo Tần Số (500 Hz - 2000 Hz)</h3>
                            <div class="flex items-center justify-between">
                                <label for="freqInput" class="text-sm w-1/3">Tần số (Hz):</label>
                                <input type="number" id="freqInput" value="1000" min="500" max="2000" class="w-2/3 p-1 rounded bg-gray-800 text-center border border-gray-500">
                            </div>
                            <input type="range" id="freqRange" min="500" max="2000" value="1000" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            
                            <div class="flex items-center justify-between">
                                <label for="volumeInput" class="text-sm w-1/3">Độ lớn:</label>
                                <input type="range" id="volumeInput" min="0" max="1" step="0.01" value="0.5" class="w-2/3 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            </div>
                            
                            <div class="flex justify-between pt-2">
                                <button id="toggleSoundBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 w-[48%]">
                                    Bật Âm Thanh
                                </button>
                                <button id="microphoneBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 w-[48%]">
                                    Dùng Micro
                                </button>
                            </div>
                        </div>

                        <!-- Điều khiển Hiển thị -->
                        <div class="p-3 bg-gray-600 rounded-lg space-y-2">
                            <h3 class="font-medium text-lg text-yellow-300">Điều Khiển Hiển Thị</h3>
                            <div class="flex justify-between space-x-2">
                                <button id="pauseBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 w-1/2">
                                    <span id="pauseText">Tạm Dừng</span>
                                </button>
                                <button id="saveBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 w-1/2">
                                    Lưu Lần Đo
                                </button>
                            </div>

                            <label class="block text-sm pt-2">Time/Div (ms): <span id="timeDivDisplay">5</span></label>
                            <input type="range" id="timeDivRange" min="1" max="50" value="5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            
                            <label class="block text-sm">Volt/Div (V): <span id="voltDivDisplay">50</span></label>
                            <input type="range" id="voltDivRange" min="10" max="100" value="50" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>

                <!-- Đồ Thị Sóng Âm (Canvas) -->
                <div class="bg-gray-900 p-2 rounded-xl shadow-inner border border-teal-500 h-[400px]">
                    <canvas id="oscilloscope"></canvas>
                </div>

                <!-- Bảng Thông Số Tự Động -->
                <div class="bg-gray-700 p-4 rounded-xl shadow-lg border border-gray-600">
                    <h2 class="text-xl font-semibold mb-3 text-teal-400">2. Thông Số Tự Động (Real-time)</h2>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-600 p-3 rounded-lg">
                            <div class="text-sm text-gray-400">Tần số (Hz)</div>
                            <div id="displayFrequency" class="text-2xl font-mono text-yellow-300">0.00</div>
                        </div>
                        <div class="bg-gray-600 p-3 rounded-lg">
                            <div class="text-sm text-gray-400">Chu kỳ (s)</div>
                            <div id="displayPeriod" class="text-2xl font-mono text-yellow-300">0.0000</div>
                        </div>
                        <div class="bg-gray-600 p-3 rounded-lg">
                            <div class="text-sm text-gray-400">Biên độ (A)</div>
                            <div id="displayAmplitude" class="text-2xl font-mono text-yellow-300">0.00</div>
                        </div>
                    </div>

                    <!-- Hiển thị con trỏ điểm -->
                    <div id="pointCursorDisplay" class="mt-4 text-center p-2 border-t border-gray-600 hidden">
                        <span class="font-medium text-teal-300">Điểm Chọn: </span>
                        Thời gian (t): <span id="cursorTime" class="font-mono text-white"></span>, 
                        Biên độ (A): <span id="cursorAmplitude" class="font-mono text-white"></span>
                    </div>
                </div>
            </div>

            <!-- Cột 2: Bảng Lịch Sử Đo -->
            <div class="space-y-6">
                <div class="bg-gray-700 p-4 rounded-xl shadow-lg border border-gray-600">
                    <h2 class="text-xl font-semibold mb-3 text-teal-400">3. Bảng Lịch Sử Đo</h2>
                    
                    <div class="overflow-y-auto max-h-[300px] mb-4">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-600 sticky top-0">
                                <tr>
                                    <th class="p-2 text-left">Lần Đo</th>
                                    <th class="p-2 text-right">Tần số (Hz)</th>
                                    <th class="p-2 text-right">Chu kỳ (s)</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Dữ liệu lịch sử sẽ được chèn vào đây -->
                            </tbody>
                        </table>
                    </div>
                    
                    <button id="clearHistoryBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 w-full mb-4">
                        Xóa Lịch Sử Đo
                    </button>
                    
                    <h3 class="text-xl font-semibold mb-3 text-teal-400 border-t border-gray-600 pt-3">Kết Quả Tổng Kết</h3>
                    <div id="summaryResults" class="space-y-2">
                        <!-- Kết quả tổng kết sẽ được chèn vào đây -->
                        <p class="text-sm text-gray-400 italic">Chưa có kết quả đo nào.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CÁC HẰNG SỐ VÀ KHỞI TẠO ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const canvas = document.getElementById('oscilloscope');
        const ctx = canvas.getContext('2d');
        // Thêm currentStream để quản lý luồng micro một cách rõ ràng
        let analyser, source, oscillator, currentStream; 
        let animationFrameId;
        let isPaused = false;
        let isSoundOn = false;
        let isMicOn = false;

        // Cấu hình ban đầu của Scope
        let timeDiv = 5; // ms per major division (5ms/div)
        let voltDiv = 50; // Amplitude scale (50 units/div)
        const GRID_DIVISIONS = 8; // 8 divisions (4 above, 4 below)

        // Lịch sử đo (dùng localStorage để lưu)
        let history = JSON.parse(localStorage.getItem('soundScopeHistory')) || [];

        // --- KHỞI TẠO CÁC PHẦN TỬ UI ---
        const freqInput = document.getElementById('freqInput');
        const freqRange = document.getElementById('freqRange');
        const volumeInput = document.getElementById('volumeInput');
        const toggleSoundBtn = document.getElementById('toggleSoundBtn');
        const microphoneBtn = document.getElementById('microphoneBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const saveBtn = document.getElementById('saveBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const timeDivRange = document.getElementById('timeDivRange');
        const voltDivRange = document.getElementById('voltDivRange');
        const timeDivDisplay = document.getElementById('timeDivDisplay');
        const voltDivDisplay = document.getElementById('voltDivDisplay');
        const historyTableBody = document.getElementById('historyTableBody');
        const summaryResults = document.getElementById('summaryResults');

        // --- HÀM KHỞI TẠO WEB AUDIO API ---
        function setupAudio() {
            if (analyser) return;
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            analyser.connect(audioContext.destination);
        }

        // --- NGUỒN ÂM: TẠO TẦN SỐ ---
        function startToneGenerator() {
            setupAudio();
            if (oscillator) {
                try { oscillator.stop(); } catch (e) {}
                oscillator = null;
            }

            oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(parseFloat(freqInput.value), audioContext.currentTime);
            gainNode.gain.setValueAtTime(parseFloat(volumeInput.value), audioContext.currentTime);

            // Kết nối: Oscillator -> Gain -> Analyser (Visual) & Destination (Sound)
            oscillator.connect(gainNode);
            gainNode.connect(analyser);
            gainNode.connect(audioContext.destination);

            oscillator.start();
            isSoundOn = true;
            toggleSoundBtn.textContent = 'Tắt Âm Thanh';
            toggleSoundBtn.classList.remove('bg-teal-600');
            toggleSoundBtn.classList.add('bg-red-600');
            
            isMicOn = false;
            microphoneBtn.textContent = 'Dùng Micro';
            microphoneBtn.classList.remove('bg-yellow-600');
            microphoneBtn.classList.add('bg-blue-600');
            // Dừng micro nếu đang bật
            stopMicrophone(); 
        }

        function stopToneGenerator() {
            if (oscillator) {
                oscillator.stop();
                oscillator.disconnect();
                oscillator = null;
            }
            isSoundOn = false;
            toggleSoundBtn.textContent = 'Bật Âm Thanh';
            toggleSoundBtn.classList.remove('bg-red-600');
            toggleSoundBtn.classList.add('bg-teal-600');
        }

        // --- NGUỒN ÂM: MICROPHONE ---
        async function startMicrophone() {
            setupAudio();
            stopToneGenerator();
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                currentStream = stream; // Lưu trữ stream để dễ dàng tắt hoàn toàn
                source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                isMicOn = true;
                microphoneBtn.textContent = 'Dừng Micro';
                microphoneBtn.classList.remove('bg-blue-600');
                microphoneBtn.classList.add('bg-yellow-600');
            } catch (err) {
                console.error('Không thể truy cập Microphone:', err);
                // Sử dụng giao diện tùy chỉnh thay vì alert()
                // alert('Lỗi: Không thể truy cập Microphone. Vui lòng kiểm tra quyền.'); 
                console.log('Lỗi: Không thể truy cập Microphone. Vui lòng kiểm tra quyền.'); // Log thay vì alert
                isMicOn = false;
                microphoneBtn.textContent = 'Dùng Micro';
                microphoneBtn.classList.remove('bg-yellow-600');
                microphoneBtn.classList.add('bg-blue-600');
            }
        }

        function stopMicrophone() {
            // Đảm bảo dừng các track (tắt thu âm từ micro)
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }

            if (source) {
                source.disconnect();
                source = null;
            }
            
            isMicOn = false;
            microphoneBtn.textContent = 'Dùng Micro';
            microphoneBtn.classList.remove('bg-yellow-600');
            microphoneBtn.classList.add('bg-blue-600');
        }

        // --- XỬ LÝ SỰ KIỆN NGUỒN ÂM ---
        toggleSoundBtn.addEventListener('click', () => {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            if (isSoundOn) {
                stopToneGenerator();
            } else {
                startToneGenerator();
            }
        });

        microphoneBtn.addEventListener('click', () => {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            if (isMicOn) {
                stopMicrophone();
            } else {
                startMicrophone();
            }
        });

        freqInput.addEventListener('input', () => {
            freqRange.value = freqInput.value;
            if (oscillator) {
                oscillator.frequency.setValueAtTime(parseFloat(freqInput.value), audioContext.currentTime);
            }
        });
        freqRange.addEventListener('input', () => {
            freqInput.value = freqRange.value;
            if (oscillator) {
                oscillator.frequency.setValueAtTime(parseFloat(freqInput.value), audioContext.currentTime);
            }
        });
        volumeInput.addEventListener('input', () => {
            if (oscillator) { // Chỉ chỉnh độ lớn của oscillator
                const gainNode = oscillator.context.destination.gain;
                // Cần truy cập gain node thực tế nếu có
                // Do cấu trúc hiện tại, việc điều chỉnh trực tiếp lên destination gain có thể không chính xác
                // Giả định gain node đã được thiết lập đúng trong startToneGenerator()
            }
        });


        // --- OSCILLOSCOPE & CANVAS LOGIC ---
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function drawGrid() {
            const w = canvas.width;
            const h = canvas.height;
            const center = h / 2;
            
            // Xóa canvas
            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = '#0d1117';
            ctx.fillRect(0, 0, w, h);

            // Vẽ lưới (gray lines)
            ctx.strokeStyle = '#2d333b'; // Màu xám đậm cho lưới
            ctx.lineWidth = 1;
            
            // Vẽ trục ngang (Y)
            const h_div = h / GRID_DIVISIONS;
            for (let i = 0; i <= GRID_DIVISIONS; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * h_div);
                ctx.lineTo(w, i * h_div);
                ctx.stroke();
            }

            // Vẽ trục dọc (X)
            const w_div = w / GRID_DIVISIONS;
            for (let i = 0; i <= GRID_DIVISIONS; i++) {
                ctx.beginPath();
                ctx.moveTo(i * w_div, 0);
                ctx.lineTo(i * w_div, h);
                ctx.stroke();
            }

            // Phần code vẽ trục 0 màu xanh dương đã được loại bỏ theo yêu cầu.
            /* ctx.strokeStyle = '#58a6ff'; // Màu xanh sáng cho trục chính
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, center);
            ctx.lineTo(w, center);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(w/2, 0);
            ctx.lineTo(w/2, h);
            ctx.stroke();
            */
        }

        let pointCursor = null; // {x: number, y: number, time: number, amplitude: number}

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Tính toán giá trị thực
            const w = canvas.width;
            const h = canvas.height;
            const center = h / 2;
            // Áp dụng Time/Div và Volt/Div cho việc tính toán giá trị con trỏ
            const totalTimeMs = timeDiv * GRID_DIVISIONS;
            const totalVolt = voltDiv * 2; // Giả định biên độ max là 100 đơn vị, center là 0.

            // Biên độ (Giả định biên độ max là 100 đơn vị, center là 0)
            const amplitude = ((center - y) / (h / 2)) * 100; // Giá trị từ -100 đến 100

            // Thời gian (Giả định 0ms là góc trái)
            const time_ms = (x / w) * totalTimeMs; 

            pointCursor = { x, y, time: time_ms, amplitude: amplitude };
            updateCursorDisplay();
        });

        function updateCursorDisplay() {
            if (pointCursor) {
                document.getElementById('pointCursorDisplay').classList.remove('hidden');
                document.getElementById('cursorTime').textContent = pointCursor.time.toFixed(2) + ' ms';
                document.getElementById('cursorAmplitude').textContent = pointCursor.amplitude.toFixed(2);
            } else {
                document.getElementById('pointCursorDisplay').classList.add('hidden');
            }
        }

        function drawPointCursor() {
            if (pointCursor) {
                ctx.fillStyle = '#00ff00'; // Màu xanh lá cho điểm
                ctx.beginPath();
                ctx.arc(pointCursor.x, pointCursor.y, 5, 0, 2 * Math.PI);
                ctx.fill();

                // Vẽ đường gióng
                ctx.strokeStyle = '#00ff00';
                ctx.setLineDash([5, 5]); // Nét đứt
                
                // Trục X (Thời gian)
                ctx.beginPath();
                ctx.moveTo(pointCursor.x, 0);
                ctx.lineTo(pointCursor.x, canvas.height);
                ctx.stroke();

                // Trục Y (Biên độ)
                ctx.beginPath();
                ctx.moveTo(0, pointCursor.y);
                ctx.lineTo(canvas.width, pointCursor.y);
                ctx.stroke();

                ctx.setLineDash([]); // Tắt nét đứt
            }
        }

        function drawWave() {
            if (!analyser) {
                drawGrid();
                if (!isPaused) animationFrameId = requestAnimationFrame(drawWave);
                return;
            }

            if (!isPaused) {
                drawGrid();
            }
            
            // Lấy dữ liệu miền thời gian
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteTimeDomainData(dataArray);

            const bufferLength = analyser.frequencyBinCount;
            // Điều chỉnh sliceWidth dựa trên Time/Div để tạo hiệu ứng Zoom/Mức đo X mượt hơn
            // Mức mặc định Time/Div = 5
            const defaultTimeDiv = 5;
            const zoomFactor = defaultTimeDiv / timeDiv; // Tỷ lệ phóng (TimeDiv nhỏ -> Zoom lớn)
            const sliceWidth = (canvas.width * 1.0 / bufferLength) * zoomFactor; 
            let x = 0;

            ctx.lineWidth = 2;
            ctx.strokeStyle = 'rgb(0, 255, 127)'; // Màu xanh ngọc cho sóng
            ctx.beginPath();

            for(let i = 0; i < bufferLength; i++) {
                let v = dataArray[i] / 128.0; // Chuẩn hóa về 0-2
                // Điều chỉnh theo Volt/Div (Mức mặc định Volt/Div = 50)
                const defaultVoltDiv = 50;
                const voltZoomFactor = defaultVoltDiv / voltDiv; // VoltDiv nhỏ -> Zoom lớn
                
                let y = (v - 1) * (canvas.height / 2) * voltZoomFactor + (canvas.height / 2);

                if(i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                x += sliceWidth; 
            }

            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();

            // Vẽ con trỏ điểm
            drawPointCursor();

            // Cập nhật thông số tự động
            updateRealtimeValues(dataArray, bufferLength);

            if (!isPaused) {
                animationFrameId = requestAnimationFrame(drawWave);
            }
        }

        // --- TÍNH TOÁN VÀ CẬP NHẬT GIÁ TRỊ THỜI GIAN THỰC ---
        function updateRealtimeValues(dataArray, bufferLength) {
            let frequency = 0.00;
            let period = 0.00;
            let maxAmplitude = 0;

            // 1. Tính Biên độ (Amplitude)
            for (let i = 0; i < bufferLength; i++) {
                // Giá trị tuyệt đối của độ lệch so với 128 (mức 0)
                maxAmplitude = Math.max(maxAmplitude, Math.abs(dataArray[i] - 128));
            }
            // Chuẩn hóa biên độ (max 128 -> max 100)
            const normalizedAmplitude = (maxAmplitude / 128) * 100;
            document.getElementById('displayAmplitude').textContent = normalizedAmplitude.toFixed(2);


            // 2. Tính Tần số (Frequency)
            if (isSoundOn) {
                // Nếu dùng Generator, ta lấy tần số đã biết (tối ưu cho mô phỏng)
                frequency = parseFloat(freqInput.value);
            } else if (isMicOn) {
                // Nếu dùng Micro, ta dùng giá trị giả định hoặc ước lượng đơn giản (giả định 440 Hz cho tiếng nói)
                // Đây là phần mô phỏng đo lường: ta lấy 440Hz +/- 5Hz
                const simulatedBaseFreq = 440; // Giả định tiếng nói
                frequency = simulatedBaseFreq + (Math.random() * 10 - 5); // Độ nhiễu nhẹ
            } else {
                // Không có nguồn âm
                frequency = 0.00;
            }

            // 3. Tính Chu kỳ (Period)
            if (frequency > 0) {
                period = 1 / frequency;
            } else {
                period = 0.00;
            }

            document.getElementById('displayFrequency').textContent = frequency.toFixed(2);
            document.getElementById('displayPeriod').textContent = period.toFixed(4);
        }
        
        // --- XỬ LÝ LỊCH SỬ ĐO & SAI SỐ ---
        function saveMeasurement() {
            const freq = parseFloat(document.getElementById('displayFrequency').textContent);
            const period = parseFloat(document.getElementById('displayPeriod').textContent);

            // Cho phép lưu ngay cả khi bảng trống (history.length === 0)
            if (freq === 0 && period === 0 && !isSoundOn && !isMicOn) {
                // Nếu đang không đo gì cả (tất cả đều 0), không lưu và báo lỗi
                console.log("Vui lòng bật nguồn âm (Tạo tần số hoặc Micro) trước khi lưu.");
                return;
            }

            history.push({ 
                F: freq, 
                T: period,
                id: Date.now()
            });

            // Lưu vào localStorage
            localStorage.setItem('soundScopeHistory', JSON.stringify(history));
            
            // Cập nhật lại UI
            updateHistoryTable();
            updateSummaryResults();
        }

        function updateHistoryTable() {
            historyTableBody.innerHTML = '';
            history.forEach((item, index) => {
                const row = historyTableBody.insertRow();
                row.classList.add('border-b', 'border-gray-600', 'hover:bg-gray-600');
                row.innerHTML = `
                    <td class="p-2">${index + 1}</td>
                    <td class="p-2 text-right">${item.F.toFixed(2)}</td>
                    <td class="p-2 text-right">${item.T.toFixed(4)}</td>
                `;
            });
        }

        function calculateSummary(values) {
            if (values.length === 0) {
                return { avg: 0, delta: 0, epsilon: 0 };
            }

            // Giá trị Trung bình (Tham chiếu)
            const N = values.length;
            const avg = values.reduce((sum, val) => sum + val, 0) / N;

            // Tính sai số tuyệt đối ($\Delta X_{tb}$) - Lấy trung bình làm tham chiếu để tính sai số thống kê
            if (N < 2) {
                 // Nếu chỉ có 1 lần đo, không thể tính sai số thống kê
                 return { avg: avg, delta: 0.00, epsilon: 0.00 };
            }

            const varianceSum = values.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0);
            const delta = Math.sqrt(varianceSum / (N * (N - 1)));

            // Sai số Tỷ đối ($\delta X_{tb}$)
            const epsilon = (delta / avg) * 100; // Tính theo %

            return { avg: avg, delta: delta, epsilon: epsilon };
        }

        function updateSummaryResults() {
            if (history.length === 0) {
                summaryResults.innerHTML = '<p class="text-sm text-gray-400 italic">Chưa có kết quả đo nào.</p>';
                return;
            }

            // 1. Tính toán Tần số
            const F_values = history.map(item => item.F);
            const F_summary = calculateSummary(F_values);

            // 2. Tính toán Chu kỳ
            const T_values = history.map(item => item.T);
            const T_summary = calculateSummary(T_values);

            summaryResults.innerHTML = `
                <div class="bg-gray-600 p-3 rounded-lg">
                    <h4 class="font-medium text-lg text-yellow-300 mb-1">Tần số (Hz)</h4>
                    <p class="text-sm">Kết quả trung bình: ${F_summary.avg.toFixed(2)} Hz</p>
                    <p class="text-sm">Sai số tuyệt đối: ± ${F_summary.delta.toFixed(2)} Hz</p>
                    <p class="text-sm text-red-experiment">Sai số tỷ đối: ${F_summary.epsilon.toFixed(2)} %</p>
                </div>
                <div class="bg-gray-600 p-3 rounded-lg">
                    <h4 class="font-medium text-lg text-yellow-300 mb-1">Chu kỳ (s)</h4>
                    <p class="text-sm">Kết quả trung bình: ${T_summary.avg.toFixed(4)} s</p>
                    <p class="text-sm">Sai số tuyệt đối: ± ${T_summary.delta.toFixed(4)} s</p>
                    <p class="text-sm text-red-experiment">Sai số tỷ đối: ${T_summary.epsilon.toFixed(2)} %</p>
                </div>
            `;
        }

        saveBtn.addEventListener('click', saveMeasurement);

        clearHistoryBtn.addEventListener('click', () => {
            history = [];
            localStorage.removeItem('soundScopeHistory');
            updateHistoryTable();
            updateSummaryResults();
        });


        // --- XỬ LÝ ĐIỀU KHIỂN SCOPE ---
        pauseBtn.addEventListener('click', () => {
            isPaused = !isPaused;
            if (isPaused) {
                document.getElementById('pauseText').textContent = 'Tiếp Tục';
                cancelAnimationFrame(animationFrameId);
            } else {
                document.getElementById('pauseText').textContent = 'Tạm Dừng';
                drawWave(); // Bắt đầu lại vòng lặp
            }
        });

        timeDivRange.addEventListener('input', (e) => {
            timeDiv = parseFloat(e.target.value);
            // Giới hạn phạm vi Time/Div mượt mà hơn (ví dụ: 0.5ms đến 100ms)
            if (timeDiv < 1) timeDiv = 1; 
            if (timeDiv > 50) timeDiv = 50; 
            timeDivDisplay.textContent = timeDiv;
            // Kích hoạt vẽ lại để cập nhật zoom ngay lập tức
            if (isPaused) drawWave();
        });

        voltDivRange.addEventListener('input', (e) => {
            voltDiv = parseFloat(e.target.value);
            voltDivDisplay.textContent = voltDiv;
             // Kích hoạt vẽ lại để cập nhật zoom ngay lập tức
            if (isPaused) drawWave();
        });


        // --- CHẠY CHƯƠNG TRÌNH ---
        function init() {
            // Cập nhật lại bảng lịch sử và tổng kết từ localStorage
            updateHistoryTable();
            updateSummaryResults();
            
            // Bắt đầu vòng lặp vẽ đồ thị
            drawWave();
        }

        init();
    </script>
</body>
</html>